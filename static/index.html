<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phage Plaque Counter</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Phage Plaque Counter</h1>
            <p class="subtitle">AI-powered bacteriophage plaque detection and counting</p>
        </header>

        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-label">Current Count:</span>
                <span id="current-count" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Saved Annotations:</span>
                <span id="annotation-count" class="stat-value">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Model Version:</span>
                <span id="model-version" class="stat-value">0</span>
            </div>
        </div>

        <div class="main-content">
            <!-- Step 1: Capture/Upload Section -->
            <div class="section upload-section">
                <h2>1. Capture or Upload Image</h2>

                <div class="image-source-options">
                    <button id="camera-btn" class="btn btn-secondary">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        Take Photo
                    </button>
                    <button id="upload-btn" class="btn btn-secondary">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        Upload Image
                    </button>
                </div>

                <input type="file" id="image-input" accept="image/*" hidden>

                <!-- Camera Preview -->
                <div id="camera-container" style="display: none;">
                    <video id="camera-preview" autoplay playsinline></video>
                    <div class="camera-controls">
                        <button id="capture-btn" class="btn btn-primary">Capture Photo</button>
                        <button id="cancel-camera-btn" class="btn btn-secondary">Cancel</button>
                    </div>
                </div>

                <!-- Image Preview -->
                <div id="preview-container" style="display: none;">
                    <img id="image-preview" alt="Preview">
                    <button id="analyze-btn" class="btn btn-primary">Detect Plaques</button>
                </div>
            </div>

            <!-- Step 2: Interactive Annotation Section -->
            <div class="section annotation-section" id="annotation-section" style="display: none;">
                <h2>2. Review and Correct Detections</h2>

                <div class="annotation-instructions">
                    <div class="instruction-item">
                        <span class="instruction-icon">üñ±Ô∏è</span>
                        <span>Click on image to <strong>add</strong> a plaque</span>
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-icon">‚ùå</span>
                        <span>Click on existing plaque to <strong>remove</strong> it</span>
                    </div>
                    <div class="instruction-item">
                        <span class="instruction-icon">‚öôÔ∏è</span>
                        <span>Adjust detection parameters below</span>
                    </div>
                </div>

                <div class="annotation-container">
                    <!-- Canvas for interactive annotation -->
                    <div class="canvas-wrapper">
                        <canvas id="annotation-canvas"></canvas>
                    </div>

                    <!-- Detection Parameters Panel -->
                    <div class="parameters-panel">
                        <h3>Detection Parameters</h3>

                        <div class="parameter-group">
                            <label for="min-radius">Minimum Plaque Size:</label>
                            <input type="range" id="min-radius" min="3" max="20" value="5" step="1">
                            <span id="min-radius-value">5px</span>
                        </div>

                        <div class="parameter-group">
                            <label for="max-radius">Maximum Plaque Size:</label>
                            <input type="range" id="max-radius" min="20" max="100" value="50" step="5">
                            <span id="max-radius-value">50px</span>
                        </div>

                        <div class="parameter-group">
                            <label for="sensitivity">Detection Sensitivity:</label>
                            <input type="range" id="sensitivity" min="10" max="50" value="30" step="1">
                            <span id="sensitivity-value">30</span>
                        </div>

                        <div class="parameter-group">
                            <label for="min-distance">Minimum Distance:</label>
                            <input type="range" id="min-distance" min="10" max="50" value="20" step="1">
                            <span id="min-distance-value">20px</span>
                        </div>

                        <button id="redetect-btn" class="btn btn-secondary">Re-detect with Parameters</button>

                        <div class="count-info">
                            <h3>Plaque Count</h3>
                            <div class="count-breakdown">
                                <div class="count-item">
                                    <span class="count-type auto">Auto-detected:</span>
                                    <span id="auto-count">0</span>
                                </div>
                                <div class="count-item">
                                    <span class="count-type manual">Manually added:</span>
                                    <span id="manual-count">0</span>
                                </div>
                                <div class="count-item total">
                                    <span class="count-type">Total:</span>
                                    <span id="total-count">0</span>
                                </div>
                            </div>
                        </div>

                        <div class="annotation-mode">
                            <h4>Annotation Mode</h4>
                            <div class="mode-buttons">
                                <button id="mode-add" class="mode-btn active" data-mode="add">
                                    ‚ûï Add Plaque
                                </button>
                                <button id="mode-remove" class="mode-btn" data-mode="remove">
                                    ‚ûñ Remove Plaque
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Save Section -->
            <div class="section save-section" id="save-section" style="display: none;">
                <h2>3. Save Results</h2>

                <div class="save-container">
                    <div class="save-form">
                        <div class="form-group">
                            <label for="sample-name">Sample Name (optional):</label>
                            <input type="text" id="sample-name" placeholder="e.g., Sample-001, Experiment-A">
                        </div>

                        <div class="form-group">
                            <label for="notes">Notes:</label>
                            <textarea id="notes" rows="3" placeholder="Add any observations or comments..."></textarea>
                        </div>

                        <div class="save-options">
                            <label>
                                <input type="checkbox" id="save-image" checked>
                                Save annotated image
                            </label>
                            <label>
                                <input type="checkbox" id="save-data" checked>
                                Save count data
                            </label>
                        </div>

                        <div class="save-buttons">
                            <button id="save-btn" class="btn btn-success">
                                üíæ Save Results
                            </button>
                            <button id="download-btn" class="btn btn-secondary">
                                ‚¨áÔ∏è Download Image
                            </button>
                            <button id="new-image-btn" class="btn btn-secondary">
                                üîÑ Analyze New Image
                            </button>
                        </div>
                    </div>

                    <div class="save-preview">
                        <h3>Final Result Preview</h3>
                        <canvas id="preview-canvas"></canvas>
                        <div class="result-summary">
                            <p><strong>Total Plaques:</strong> <span id="final-count">0</span></p>
                            <p><strong>Auto-detected:</strong> <span id="final-auto">0</span></p>
                            <p><strong>Manual corrections:</strong> <span id="final-manual">0</span></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Saved Results History -->
            <div class="section history-section" id="history-section">
                <h2>Saved Results</h2>
                <div id="results-history"></div>
            </div>

            <!-- Model Training Section -->
            <div class="section training-section">
                <h2>Model Training</h2>
                <div class="training-info">
                    <p>Collect annotated samples to improve detection accuracy.</p>
                    <button id="retrain-btn" class="btn btn-primary" disabled>
                        Train Model (<span id="train-count">0</span>/5 minimum)
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loading-overlay">
            <div class="spinner"></div>
            <p id="loading-text">Processing...</p>
        </div>

        <!-- Toast Notification -->
        <div class="toast" id="toast"></div>
    </div>

    <footer>
        <p>Phage Plaque Counter v2.0 | Interactive Annotation System</p>
    </footer>

    <script src="app.js"></script>
</body>
</html>
